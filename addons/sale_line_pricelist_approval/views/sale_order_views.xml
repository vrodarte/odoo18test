<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario de Orden de Venta -->
    <record id="view_order_form_inherit_pricelist_approval" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.pricelist.approval</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            
            <!-- Añadir botones en el header -->
            <xpath expr="//header/button[@name='action_confirm'][1]" position="before">
                <button name="action_request_approval" 
                        type="object" 
                        string="Solicitar Aprobación"
                        class="btn-primary"
                        attrs="{'invisible': ['|', ('has_pending_approval', '=', False), ('state', 'not in', ['draft', 'sent'])]}"
                        icon="fa-check-circle"/>
                
                <button name="action_approve_prices" 
                        type="object" 
                        string="Aprobar Precios"
                        class="btn-success"
                        groups="sale_line_pricelist_approval.group_sale_price_approver"
                        attrs="{'invisible': ['|', ('has_pending_approval', '=', False), ('state', '!=', 'to_approve')]}"
                        icon="fa-thumbs-up"/>
                
                <button name="action_reject_prices" 
                        type="object" 
                        string="Rechazar Precios"
                        class="btn-danger"
                        groups="sale_line_pricelist_approval.group_sale_price_approver"
                        attrs="{'invisible': ['|', ('has_pending_approval', '=', False), ('state', '!=', 'to_approve')]}"
                        icon="fa-thumbs-down"/>
            </xpath>
            
            <!-- Añadir el estado 'to_approve' en el statusbar -->
            <xpath expr="//header/field[@name='state']" position="attributes">
                <attribute name="statusbar_visible">draft,to_approve,sent,sale</attribute>
            </xpath>
            
            <!-- Añadir campos computados invisibles -->
            <xpath expr="//sheet" position="before">
                <field name="has_pending_approval" invisible="1"/>
                <field name="can_approve" invisible="1"/>
            </xpath>
            
            <!-- Modificar la vista list de order_line -->
            <xpath expr="//field[@name='order_line']/list" position="attributes">
                <attribute name="decoration-warning">x_approval_status == 'pending'</attribute>
                <attribute name="decoration-success">x_approval_status == 'approved'</attribute>
                <attribute name="decoration-danger">x_approval_status == 'rejected'</attribute>
            </xpath>
            
            <!-- Añadir columnas en la vista list de líneas -->
            <xpath expr="//field[@name='order_line']/list/field[@name='product_template_id']" position="after">
                <field name="x_pricing_choice" 
                       string="Tipo Precio"
                       widget="selection"
                       required="1"/>
                
                <field name="x_pricelist_id" 
                       string="Lista Precios"
                       options="{'no_create': True, 'no_create_edit': True}"
                       attrs="{'invisible': [('x_pricing_choice', '!=', 'pricelist')], 
                               'required': [('x_pricing_choice', '=', 'pricelist')]}"/>
            </xpath>
            
            <xpath expr="//field[@name='order_line']/list/field[@name='price_unit']" position="attributes">
                <attribute name="attrs">{'readonly': [('x_pricing_choice', '=', 'pricelist')]}</attribute>
                <attribute name="decoration-bf">x_pricing_choice == 'manual'</attribute>
            </xpath>
            
            <xpath expr="//field[@name='order_line']/list/field[@name='price_subtotal']" position="after">
                <field name="x_approval_status" 
                       string="Estado Apr."
                       widget="badge"
                       decoration-warning="x_approval_status == 'pending'"
                       decoration-success="x_approval_status == 'approved'"
                       decoration-danger="x_approval_status == 'rejected'"/>
                
                <field name="x_original_price" 
                       string="Precio Original"
                       optional="hide"
                       readonly="1"/>
            </xpath>
            
            <!-- Vista de formulario para las líneas (popup) -->
            <xpath expr="//field[@name='order_line']/form" position="inside">
                <sheet>
                    <group>
                        <group string="Configuración de Precio">
                            <field name="x_pricing_choice" widget="radio"/>
                            <field name="x_pricelist_id" 
                                   attrs="{'invisible': [('x_pricing_choice', '!=', 'pricelist')],
                                           'required': [('x_pricing_choice', '=', 'pricelist')]}"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="x_original_price" 
                                   attrs="{'invisible': [('x_pricing_choice', '!=', 'manual')]}"
                                   readonly="1"/>
                        </group>
                        <group string="Estado de Aprobación" 
                               attrs="{'invisible': [('x_pricing_choice', '!=', 'manual')]}">
                            <field name="x_approval_status" widget="badge"/>
                            <field name="x_approved_by" 
                                   attrs="{'invisible': [('x_approval_status', 'not in', ['approved', 'rejected'])]}"/>
                            <field name="x_approval_date" 
                                   attrs="{'invisible': [('x_approval_status', 'not in', ['approved', 'rejected'])]}"/>
                        </group>
                    </group>
                </sheet>
            </xpath>
        </field>
    </record>
    
    <!-- Vista de lista de órdenes de venta -->
    <record id="view_quotation_tree_inherit_pricelist_approval" model="ir.ui.view">
        <field name="name">sale.order.tree.inherit.pricelist.approval</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="attributes">
                <attribute name="decoration-warning">state == 'to_approve'</attribute>
            </xpath>
            
            <xpath expr="//field[@name='state']" position="before">
                <field name="has_pending_approval" 
                       string="Aprobación Pend."
                       widget="boolean_toggle"
                       optional="show"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista de búsqueda -->
    <record id="view_sales_order_filter_inherit_pricelist_approval" model="ir.ui.view">
        <field name="name">sale.order.search.inherit.pricelist.approval</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='draft']" position="after">
                <filter string="Esperando Aprobación" 
                        name="to_approve" 
                        domain="[('state', '=', 'to_approve')]"/>
                <separator/>
                <filter string="Con Precios Pendientes" 
                        name="has_pending" 
                        domain="[('has_pending_approval', '=', True)]"/>
            </xpath>
            
            <xpath expr="//group" position="inside">
                <filter string="Estado de Aprobación" 
                        name="groupby_approval_state" 
                        context="{'group_by': 'state'}"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista de formulario para Lista de Precios -->
    <record id="product_pricelist_view_form_inherit" model="ir.ui.view">
        <field name="name">product.pricelist.form.inherit.line.selection</field>
        <field name="model">product.pricelist</field>
        <field name="inherit_id" ref="product.product_pricelist_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="x_is_line_pricelist" 
                       string="Disponible en líneas de venta"
                       help="Si está marcado, esta lista de precios estará disponible para selección en las líneas de pedido de venta"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista de lista para Lista de Precios -->
    <record id="product_pricelist_view_tree_inherit" model="ir.ui.view">
        <field name="name">product.pricelist.tree.inherit.line.selection</field>
        <field name="model">product.pricelist</field>
        <field name="inherit_id" ref="product.product_pricelist_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="x_is_line_pricelist" 
                       string="En Líneas"
                       widget="boolean_toggle"
                       optional="show"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista Kanban con indicador de aprobación -->
    <record id="view_sale_order_kanban_inherit_pricelist_approval" model="ir.ui.view">
        <field name="name">sale.order.kanban.inherit.pricelist.approval</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sale_order_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="inside">
                <field name="has_pending_approval"/>
            </xpath>
            
            <xpath expr="//div[hasclass('oe_kanban_bottom_right')]" position="inside">
                <span t-if="record.has_pending_approval.raw_value" 
                      class="badge badge-warning">
                    <i class="fa fa-clock-o"/> Aprobación Pendiente
                </span>
            </xpath>
        </field>
    </record>
</odoo>